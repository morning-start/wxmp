name: Create GitHub Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ steps.tag.outputs.version }}"
          CHANGELOG_FILE="wiki/CHANGELOG.md"
          
          if [ -f "$CHANGELOG_FILE" ]; then
            echo "Extracting changelog for version $VERSION..."
            
            # 提取对应版本的变更日志
            # 从版本标题开始，直到下一个版本标题或文件结束
            awk -v version="[$VERSION]" '
              BEGIN { found=0; content="" }
              /^## \[.*\]/ {
                if (found) exit
                if ($0 ~ version) found=1
                next
              }
              found { content = content $0 "\n" }
              END { 
                if (content != "") {
                  gsub(/^[ \t]+|[ \t]+$/, "", content)
                  print content
                } else {
                  print "## 主要变更\n\n请查看完整变更日志：[CHANGELOG.md](wiki/CHANGELOG.md)"
                }
              }
            ' "$CHANGELOG_FILE" > release_notes.txt
            
            # 读取内容并设置输出
            NOTES=$(cat release_notes.txt)
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "$NOTES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "## 主要变更\n\n请查看完整变更日志：[CHANGELOG.md](wiki/CHANGELOG.md)" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
