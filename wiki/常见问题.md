# 常见问题

本文档汇总了 `wxmp` 项目使用过程中的常见问题和解决方案。

---

## 安装和配置

### Q1: 如何安装 wxmp？

**A**: 使用 pip 安装：

```bash
pip install wxmp
```

或从源码安装：

```bash
git clone https://github.com/morning-start/wxmp.git
cd wxmp
pip install -e .
```

### Q2: 如何获取 Cookies？

**A**: 按照以下步骤获取微信公众平台登录后的 Cookies：

1. 在浏览器中打开 [微信公众平台](https://mp.weixin.qq.com/)
2. 登录你的公众号账号
3. 打开浏览器开发者工具（F12）
4. 切换到 Network 标签
5. 刷新页面
6. 找到任意请求，查看 Request Headers 中的 Cookie
7. 复制完整的 Cookie 字符串

**示例 Cookie 格式**:
```
wxuin=123456789; pass_ticket=abcdefg; ...
```

### Q3: Cookie 失效了怎么办？

**A**: Cookie 可能会过期，需要重新获取：

1. 重新登录微信公众平台
2. 按照上述步骤获取新的 Cookie
3. 更新你的 Cookie 文件或配置

### Q4: 支持哪些 Python 版本？

**A**: `wxmp` 支持 Python >= 3.10

---

## 使用问题

### Q5: 如何搜索公众号？

**A**: 使用 `fetch_fakeid` 方法：

```python
from wxmp import WxMPAPI

api = WxMPAPI(cookies)
response = api.fetch_fakeid("Python")

for account in response.list:
    print(f"名称: {account.nickname}")
    print(f"FakeID: {account.fakeid}")
```

### Q6: 如何下载文章？

**A**: 使用 `TimeRangeSpider` 类：

```python
from wxmp.spider import TimeRangeSpider
from datetime import datetime
from wxmp.spider import TimeRange

spider = TimeRangeSpider.from_cookies_file("cookies.json")

time_range = TimeRange(
    begin=datetime(2024, 1, 1),
    end=datetime(2024, 12, 31)
)

df = spider.search_articles_content(
    bizs={"Python编程": "MzI..."},
    time_range=time_range
)

spider.save_all_article_content(df, save_dir=Path("temp/article_content/"))
```

### Q7: 如何自定义爬虫？

**A**: 继承 `TimeRangeSpider` 或 `WxMPAPI` 类：

```python
from wxmp.spider import TimeRangeSpider

class CustomSpider(TimeRangeSpider):
    def custom_search_logic(self, keywords: list[str]):
        """自定义搜索逻辑"""
        results = []
        for keyword in keywords:
            response = self.fetch_fakeid(keyword)
            results.extend(response.list)
        return results
```

### Q8: 如何批量下载多个公众号的文章？

**A**: 使用 `load_or_search_bizs` 方法：

```python
bizs = spider.load_or_search_bizs(
    gzh_names=["Python编程", "机器学习", "数据分析"],
    cache_file=Path("temp/fakeids.json")
)

df = spider.search_articles_content(bizs, time_range)
```

---

## 技术问题

### Q9: 缓存是如何工作的？

**A**: `wxmp` 使用 Cache Aside 缓存策略：

- **FakeID 缓存**: 缓存公众号搜索结果，避免重复搜索
- **时间范围缓存**: 缓存已获取的文章时间范围，支持增量更新

详细说明请查看 [数据流动与状态管理 - 缓存策略](./数据流动与状态管理.md#缓存策略)

### Q10: 时间范围匹配算法是什么？

**A**: 时间范围匹配算法用于计算需要获取的剩余时间范围：

1. **完全无重叠**: 返回完整请求范围，替换缓存
2. **部分重叠（需要扩展结束）**: 返回扩展部分，更新缓存结束时间
3. **部分重叠（需要扩展开始）**: 返回扩展部分，更新缓存开始时间
4. **完全覆盖**: 返回 None，无需获取

详细说明请查看 [数据流动与状态管理 - 时间范围匹配算法](./数据流动与状态管理.md#2-时间范围匹配算法)

### Q11: 如何扩展 API？

**A**: 继承 `WxMPAPI` 类添加新的 API 方法：

```python
from wxmp import WxMPAPI

class ExtendedAPI(WxMPAPI):
    def custom_api_call(self, custom_params):
        """自定义 API 调用"""
        url = self.domain + "/custom/endpoint"
        params = {...}
        res = self.session.get(url, params=params, headers=self.headers)
        return res.json()
```

### Q12: 如何调整并发数？

**A**: 修改 `max_workers` 参数：

```python
spider.save_all_article_content(
    df=df,
    save_dir=Path("temp/article_content/"),
    max_workers=10,  # 增加并发数
    time_range=time_range
)
```

建议值：5-10

---

## 错误处理

### Q13: Token 获取失败怎么办？

**A**: 检查以下几点：

1. Cookie 是否有效
2. Cookie 是否过期
3. 网络连接是否正常
4. 是否被微信限制

解决方法：
- 重新登录微信公众平台获取新的 Cookie
- 检查网络连接
- 等待一段时间后重试

### Q14: 搜索公众号失败怎么办？

**A**: 可能的原因：

1. 搜索关键词无效
2. 网络连接问题
3. 被微信限制频率

解决方法：
- 检查搜索关键词是否正确
- 检查网络连接
- 降低请求频率
- 等待一段时间后重试

### Q15: 如何处理文章已失效的情况？

**A**: 使用 `is_valid_article_link` 方法检查：

```python
if api.is_valid_article_link(article.link):
    html = api.fetch_article_content(article.link)
else:
    print("文章已失效")
```

包含 `tempkey=` 参数的文章链接表示文章已删除或失效。

### Q16: 下载文章时出现错误怎么办？

**A**: 检查以下几点：

1. 文章链接是否有效
2. 网络连接是否正常
3. 是否被微信限制频率
4. 文件大小是否过小

解决方法：
- 使用 `is_valid_article_link` 检查链接
- 检查网络连接
- 降低并发数和请求频率
- 检查 `min_file_size_kb` 参数

---

## 性能问题

### Q17: 如何提高下载速度？

**A**: 可以通过以下方式提高下载速度：

1. **增加并发数**:
   ```python
   max_workers=10  # 建议 5-10
   ```

2. **使用缓存**:
   - FakeID 缓存自动启用
   - 时间范围缓存自动启用

3. **减少重试次数**:
   ```python
   task = ArticleDownloadTask(
       max_retries=1  # 减少重试次数
   )
   ```

### Q18: 如何减少内存占用？

**A**: 可以通过以下方式减少内存占用：

1. **分批处理**:
   ```python
   for i in range(0, len(articles), 100):
       batch = articles[i:i+100]
       process_batch(batch)
   ```

2. **及时清理**:
   ```python
   del df
   import gc
   gc.collect()
   ```

3. **使用流式处理**:
   ```python
   for article in articles:
       process_article(article)
   ```

---

## 数据问题

### Q19: 缓存文件在哪里？

**A**: 缓存文件位于 `temp/` 目录：

```
temp/
├── fakeids.json                          # FakeID 缓存
├── articles_info/                        # 文章信息目录
│   ├── Python编程.json                   # 时间范围缓存
│   ├── Python编程.csv                    # 文章列表
│   └── ...
└── article_content/                      # 文章内容目录
    ├── Python编程/
    │   ├── 文章1.md
    │   └── ...
    └── ...
```

### Q20: 如何清空缓存？

**A**: 删除 `temp/` 目录：

```python
import shutil

shutil.rmtree("temp")
```

或手动删除缓存文件。

### Q21: 如何导出数据为其他格式？

**A**: 使用 Pandas 导出：

```python
import pandas as pd

df = pd.read_csv("temp/articles_info/Python编程.csv")

# 导出为 Excel
df.to_excel("articles.xlsx", index=False)

# 导出为 JSON
df.to_json("articles.json", orient="records", force_ascii=False)

# 导出为 CSV（不同编码）
df.to_csv("articles.csv", index=False, encoding="utf-8-sig")
```

---

## 其他问题

### Q22: 如何获取帮助？

**A**: 可以通过以下方式获取帮助：

- 查看 [Wiki 文档](./README.md)
- 提交 [GitHub Issue](https://github.com/morning-start/wxmp/issues)
- 发送邮件至 morning-start@foxmail.com

### Q23: 如何贡献代码？

**A**: 查看 [贡献指南](./贡献指南.md) 了解详细的贡献流程。

### Q24: 项目是否支持商业使用？

**A**: 是的，项目使用 MIT License，可以自由使用、修改和分发。

### Q25: 如何报告 Bug？

**A**: 请在 [GitHub Issues](https://github.com/morning-start/wxmp/issues) 提交 Bug 报告，包含：

1. 详细的 Bug 描述
2. 复现步骤
3. 期望行为
4. 实际行为
5. 环境信息（Python 版本、操作系统等）

---

## 相关文档

- [项目概览](./项目概览.md)
- [架构设计](./架构设计.md)
- [API 文档](./API文档.md)
- [使用指南](./使用指南.md)
- [数据流动与状态管理](./数据流动与状态管理.md)
- [贡献指南](./贡献指南.md)
- [更新日志](./更新日志.md)
